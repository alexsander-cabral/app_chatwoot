<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tickets Odoo - Chatwoot</title>
    <link rel="stylesheet" href="./style.css" />

    <!-- React puro + Babel para JSX -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      // ==================== API ====================
      async function getTickets(email) {
        const API_URL = "https://chatwoot-odoo-backend.onrender.com/api/tickets";
        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });
          if (!res.ok) throw new Error(await res.text());
          return await res.json();
        } catch (e) {
          console.error("Erro ao buscar tickets:", e);
          return { tickets: [] };
        }
      }

      // ==================== COMPONENTE ====================
      function TicketsOdoo({ tickets }) {
        if (!tickets.length) return <p>Nenhum ticket encontrado.</p>;
        return (
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>TÃ­tulo</th>
                <th>Status</th>
                <th>Criado em</th>
              </tr>
            </thead>
            <tbody>
              {tickets.map((t) => (
                <tr key={t.id}>
                  <td>#{t.id}</td>
                  <td>{t.cliente}</td>
                  <td>{t.titulo}</td>
                  <td>{t.status}</td>
                  <td>{t.criado_em}</td>
                </tr>
              ))}
            </tbody>
          </table>
        );
      }

      // ==================== APP PRINCIPAL ====================
      function App() {
        const [email, setEmail] = React.useState("");
        const [tickets, setTickets] = React.useState([]);
        const [loading, setLoading] = React.useState(false);

        async function carregarTickets(mail) {
          if (!mail) return;
          setLoading(true);
          const data = await getTickets(mail);
          setTickets(ordenarTickets(data.tickets || []));
          setLoading(false);
        }

        function ordenarTickets(lista) {
          const prioridade = { "Open": 1, "New": 1, "Em andamento": 1, "Solved": 2, "Cancelado": 3, "Cancelled": 3 };
          return [...lista].sort((a, b) => {
            const pa = prioridade[a.status] || 99;
            const pb = prioridade[b.status] || 99;
            if (pa !== pb) return pa - pb;
            return new Date(b.criado_em) - new Date(a.criado_em);
          });
        }

        // Recebe email do Chatwoot via postMessage
        React.useEffect(() => {
          function handleMessage(event) {
            try {
              const data = typeof event.data === "string" ? JSON.parse(event.data) : event.data;
              const mail = data?.data?.contact?.email;
              if (mail && mail !== email) {
                console.log("[Chatwoot] Email recebido:", mail);
                setEmail(mail);
                carregarTickets(mail);
              }
            } catch (err) {
              console.error("Erro ao processar payload do Chatwoot:", err);
            }
          }

          window.addEventListener("message", handleMessage);
          // solicita payload ao Chatwoot
          window.parent.postMessage("chatwoot:request-payload", "*");
          return () => window.removeEventListener("message", handleMessage);
        }, [email]);

        return (
          <div className="container">
            <h2>Tickets do Cliente (Odoo)</h2>
            <div className="email-info">
              {email ? <p>Email detectado: <strong>{email}</strong></p> : <p>Aguardando email do Chatwoot...</p>}
            </div>

            {loading && <p>Carregando...</p>}
            {!loading && <TicketsOdoo tickets={tickets} />}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
